## Сервис бонусов
### Схема хранения данных

Хранение данных осуществляется в реплисете (replica set) MongoDB в 3 коллекциях:  
* **accounts** - коллекция аккаунтов зарегистрированных пользователей. Содержит информацию о текущем балансе бонусных баллов аккаунта;
* **orders** - коллекция зарегистрированных заказов. Содержит информацию о заказе пользователя.
* **transactions** - коллекция транзакций. Содержит информацию о движениях средств на аккаунтах пользователей.

Реплисет был развернут для поддержки механизма "транзакций" при работе с коллекциями.

### Функции сервиса

### Регистрация покупки

1. При регистрации заказа в системе в коллекцию **orders** добавляется документ с описанием заказа.
2. В коллекцию **transactions** добавляется набор транзакций по количеству товаров в заказе пользователя.
3. Каждой транзакции устанавливается статус `UNPROCESSED`.

```
POST http://bonus.service/register
{
  "user_id": уникальны_идентификатор_пользователя, // UUIDv4
  "goods": [id1, id3, id3], // идентифакаторы (UUIDv4) товаров которые приобрел пользователь
  "timestamp": UNIXTIMESTAMP, // время  когда была произведена покупка    
}
```

Варианты ответов
```
200 - покупка успешно зарегистрирована
400 - переданный запрос некорректен
409 - такая покупка уже регистрировалась 
500 - все остальные ошибки
```

### Начисление бонусов

1. Горутина с бесконечным циклом осуществляет запросы по таймауту к коллекции **transactions** и вычитывает
лимитированное количество транзакций со статусом `UNPROCESSED`, отсортированных в порядке создания транзакций.
2. На основе каждой транзакции формируется запрос к системе начисления бонусов `accrual.service`.
3. Если запрос к системе начисления бонусов, завершается с кодом http.StatusOK, то соответствующей транзакции
устанавливается статус `PROCESSED` и добавляется поле с размером пользовательского вознаграждения (положительное целое число).
4. Горутина с бесконечным циклом осуществляет запросы по таймауту к коллекции **transaction** и вычитывает лимитированное
количество транзакций со статусом `PROCESSED`.
5. Для оптимизации транзакции группируются по идентификатору аккаунта, формируется поле "суммарного пополения счёта".
6. На основе сгруппированных транзакций в коллекции **accounts** осуществляется пополение счёта каждого акканута.
7. Каждой исходной транзакции устанавливается статус `COMPLETED`.

Пункты 4-7 выполняются в течение одной транзакции в БД (в течение одной сессии в MongoDB). В случае возникновения
ошибки транзации откатываются.

```
GET http://accrual.service/info?user={USER}&good={GOOD}&timestamp={TS}
USER - уникальный идентификатор пользователя
GOOD - уникальный идентификатор товара
TS - UNIXTIMESTAMP, время  когда была произведена покупка
```

Варианты ответов
```
200 - начисление найдено, ответ - количество бонусов начисленных за покупку, может быть 0 если бонусы не полагаются
429 - превыщено количество запросов за еденицу времени, нужно сделать перерев 
404 - начисление пока еще не найдено, нужно обратится позже
500 - все остальные ошибки
```

### Списание бонусов
```
POST http://bonus.service/decrease
{
"user_id": уникальны_идентификатор_пользователя, // UUIDv4
"sum": сумма_списания, // положительное целое число
}
 ```

Варианты HTTP-ответов
```
200 - списание успешно произведено
402 - запрошенная сумма больше чем доступное количество
500 - все остальные ошибки
```